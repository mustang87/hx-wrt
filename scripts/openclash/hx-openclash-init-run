#!/bin/sh
set -eu

# =========================
# CONFIG (edit here)
# =========================

# Core (meta/mihomo)
URL_CORE_TGZ="https://bryan-pub26.oss-cn-shenzhen.aliyuncs.com/hx/vps/clash-linux-arm64.tar.gz"

# GEO (runtime in tmpfs only)
URL_GEOIP="https://bryan-pub26.oss-cn-shenzhen.aliyuncs.com/hx/vps/geoip.dat"
URL_GEOSITE="https://bryan-pub26.oss-cn-shenzhen.aliyuncs.com/hx/vps/geosite.dat"
URL_MMDB="https://bryan-pub26.oss-cn-shenzhen.aliyuncs.com/hx/vps/Country.mmdb"

# Network probe
PING_IP="223.5.5.5"
PING_TRIES="3"

# Fetch retry
FETCH_TRIES="3"
FETCH_SLEEP="2"

# =========================
# Paths / Constants
# =========================
LOG="/tmp/hx-openclash-init-run.log"
TAG="hx-openclash-init"

OC_DIR="/etc/openclash"
CORE_DIR="${OC_DIR}/core"                   # must be symlink -> /mnt/custom/openclash/core
CORE_BIN="${CORE_DIR}/clash_meta"

CUSTOM_MNT="/mnt/custom"
CUSTOM_OC_DIR="${CUSTOM_MNT}/openclash"
CUSTOM_STATE_DIR="${CUSTOM_OC_DIR}/state"
MARK="${CUSTOM_STATE_DIR}/hx-openclash-init.done"

TMP_OC_DIR="/tmp/openclash"
TMP_GEO_DIR="${TMP_OC_DIR}/geo"
TMP_CACHE_DIR="${TMP_OC_DIR}/cache"

# =========================
# Helpers
# =========================
log() { echo "[$(date -Is)] $*" >> "$LOG"; }
die() { log "ERROR: $*"; logger -t "$TAG" "ERROR: $* (see $LOG)"; exit 1; }

has_openclash() {
  [ -f /usr/lib/lua/luci/controller/openclash.lua ] && return 0
  [ -f /etc/config/openclash ] && return 0
  [ -d /usr/share/openclash ] && return 0
  return 1
}

fetch_one() {
  url="$1"
  out="$2"

  # download to temp then atomic rename
  tmp="${out}.part"
  rm -f "$tmp" >/dev/null 2>&1 || true

  if command -v curl >/dev/null 2>&1; then
    curl -4 -fSL --connect-timeout 15 --max-time 240 -o "$tmp" "$url" >>"$LOG" 2>&1
  else
    wget -4 -O "$tmp" -T 240 "$url" >>"$LOG" 2>&1
  fi

  # basic sanity check: non-empty
  [ -s "$tmp" ] || return 1
  mv -f "$tmp" "$out"
  return 0
}

fetch() {
  url="$1"
  out="$2"
  log "fetch: $url -> $out"

  i=1
  while [ "$i" -le "$FETCH_TRIES" ]; do
    if fetch_one "$url" "$out"; then
      return 0
    fi
    log "fetch failed (try $i/$FETCH_TRIES): $url"
    sleep "$FETCH_SLEEP" || true
    i=$((i+1))
  done
  return 1
}

ensure_dirs() {
  mkdir -p "$OC_DIR" "$TMP_GEO_DIR" "$TMP_CACHE_DIR" "$CUSTOM_STATE_DIR" >/dev/null 2>&1 || true
}

net_ready() {
  i=1
  while [ "$i" -le "$PING_TRIES" ]; do
    if ping -c 1 -W 1 "$PING_IP" >/dev/null 2>&1; then
      return 0
    fi
    sleep 1 || true
    i=$((i+1))
  done
  return 1
}

seed_links() {
  # GEO -> tmpfs
  ln -sf "$TMP_GEO_DIR/GeoIP.dat"    "$OC_DIR/GeoIP.dat"
  ln -sf "$TMP_GEO_DIR/GeoSite.dat"  "$OC_DIR/GeoSite.dat"
  ln -sf "$TMP_GEO_DIR/Country.mmdb" "$OC_DIR/Country.mmdb"

  # cache -> tmpfs
  if [ -e "$OC_DIR/cache" ] && [ ! -L "$OC_DIR/cache" ]; then
    rm -rf "$OC_DIR/cache" >/dev/null 2>&1 || true
  fi
  ln -snf "$TMP_CACHE_DIR" "$OC_DIR/cache"
}

install_core() {
  # core is persistent via symlink to custom
  mkdir -p "$CORE_DIR" >/dev/null 2>&1 || true

  if [ -x "$CORE_BIN" ]; then
    log "core already exists: $CORE_BIN"
    return 0
  fi

  TMP_TGZ="/tmp/clash_meta.tar.gz"
  rm -f "$TMP_TGZ" >/dev/null 2>&1 || true

  log "downloading core: $URL_CORE_TGZ"
  fetch "$URL_CORE_TGZ" "$TMP_TGZ" || return 1

  rm -rf /tmp/oc_core_extract
  mkdir -p /tmp/oc_core_extract
  tar -xzf "$TMP_TGZ" -C /tmp/oc_core_extract >>"$LOG" 2>&1 || return 1

  BIN_CANDIDATE="$(find /tmp/oc_core_extract -maxdepth 2 -type f \( -name 'clash*' -o -name 'mihomo*' \) 2>/dev/null | head -n 1 || true)"
  [ -n "$BIN_CANDIDATE" ] || return 1

  cp -f "$BIN_CANDIDATE" "$CORE_BIN"
  chmod +x "$CORE_BIN"
  log "core installed: $CORE_BIN"
  return 0
}

download_geo() {
  log "downloading geo to tmpfs"

  # If any fails, we still proceed (OpenClash may download later),
  # but we log failures clearly.
  fetch "$URL_GEOIP"   "$TMP_GEO_DIR/GeoIP.dat"    || log "WARN: GeoIP download failed"
  fetch "$URL_GEOSITE" "$TMP_GEO_DIR/GeoSite.dat"  || log "WARN: GeoSite download failed"
  fetch "$URL_MMDB"    "$TMP_GEO_DIR/Country.mmdb" || log "WARN: mmdb download failed"

  return 0
}

# =========================
# Main
# =========================
log "run start"

if ! has_openclash; then
  log "openclash not installed, exit"
  exit 0
fi

# 必须先挂载 custom，否则不做任何写入（避免写爆 overlay）
if ! mountpoint -q "$CUSTOM_MNT"; then
  log "/mnt/custom not mounted, exit (wait next boot)"
  exit 1
fi

# core 必须是软链（由 hx-storage 负责创建）
if [ ! -L "$CORE_DIR" ]; then
  log "${CORE_DIR} is not symlink, exit (avoid overlay writes)"
  exit 1
fi

ensure_dirs
seed_links

# 已完成就退出
if [ -f "$MARK" ]; then
  log "already done, exit"
  exit 0
fi

# 网络未就绪则让 procd 下次重试
if ! net_ready; then
  log "network not ready, retry next boot"
  exit 1
fi

# 1) core (persistent in custom)
install_core || die "core install failed"

# 2) GEO (tmpfs only)
download_geo || true

date > "$MARK"
log "done, mark written: $MARK"
logger -t "$TAG" "done (see $LOG)"

exit 0
