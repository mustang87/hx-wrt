#!/bin/sh /etc/rc.common
# hx-wrt storage layout (stable):
# - mtd7(Custom) -> UBI volume "custom" -> mount /mnt/custom
# - OpenClash core -> /mnt/custom/openclash/core (via symlink /etc/openclash/core)
# - GEO + cache + log -> tmpfs (/tmp/openclash/*)

START=12
STOP=90

CUSTOM_MTD_NUM="7"
CUSTOM_MTD="/dev/mtd${CUSTOM_MTD_NUM}"

# 固定一个 UBI 号，避免每次 attach 变来变去
UBI_DEV_ID="2"
UBI_DEV="/dev/ubi${UBI_DEV_ID}"
UBI_VOL_NAME="custom"
MNT="/mnt/custom"

OC_ETC="/etc/openclash"
OC_TMP="/tmp/openclash"

log() { logger -t hx-storage "$*"; echo "[hx-storage] $*"; }

ensure_dirs() {
  mkdir -p "${MNT}" \
           "${OC_ETC}" \
           "${OC_TMP}/geo" "${OC_TMP}/cache" "${OC_TMP}/log" \
           "${MNT}/openclash/core" "${MNT}/openclash/state" >/dev/null 2>&1 || true
}

attach_custom_ubi() {
  # 已经 attach 了就跳过
  [ -c "${UBI_DEV}" ] && return 0

  # 尝试固定 UBI_DEV_ID attach
  ubidetach -p "${CUSTOM_MTD}" >/dev/null 2>&1 || true

  if ubiattach -m "${CUSTOM_MTD_NUM}" -d "${UBI_DEV_ID}" >/dev/null 2>&1; then
    return 0
  fi

  # 兜底：不固定 id attach（极少数工具不支持 -d）
  ubiattach -m "${CUSTOM_MTD_NUM}" >/dev/null 2>&1 && return 0

  return 1
}

ensure_ubifs_volume() {
  # 已存在就跳过
  if ubinfo "${UBI_DEV}" -N "${UBI_VOL_NAME}" >/dev/null 2>&1; then
    return 0
  fi

  # Custom 16MiB 很紧：建议只创建 12MiB 卷，留足 UBI/坏块/磨损开销
  # （core 7MiB + 少量状态 完全够）
  ubimkvol "${UBI_DEV}" -N "${UBI_VOL_NAME}" -s 12MiB >/dev/null 2>&1
}

mount_custom() {
  mountpoint -q "${MNT}" && return 0
  mount -t ubifs "ubi${UBI_DEV_ID}:${UBI_VOL_NAME}" "${MNT}" >/dev/null 2>&1
}

link_openclash_paths() {
  # 1) core -> custom (persistent)
  # 若旧 core 是真实目录，则迁移一次（只迁移内容，不迁移大文件）
  if [ -d "${OC_ETC}/core" ] && [ ! -L "${OC_ETC}/core" ]; then
    if [ -z "$(ls -A "${MNT}/openclash/core" 2>/dev/null)" ]; then
      mv "${OC_ETC}/core/"* "${MNT}/openclash/core/" 2>/dev/null || true
    fi
    rm -rf "${OC_ETC}/core" 2>/dev/null || true
  fi
  ln -snf "${MNT}/openclash/core" "${OC_ETC}/core"

  # 2) GEO -> tmpfs (ephemeral)
  ln -sf "${OC_TMP}/geo/GeoIP.dat"    "${OC_ETC}/GeoIP.dat"
  ln -sf "${OC_TMP}/geo/GeoSite.dat"  "${OC_ETC}/GeoSite.dat"
  ln -sf "${OC_TMP}/geo/Country.mmdb" "${OC_ETC}/Country.mmdb"

  # 3) cache/log -> tmpfs
  if [ -e "${OC_ETC}/cache" ] && [ ! -L "${OC_ETC}/cache" ]; then
    rm -rf "${OC_ETC}/cache" 2>/dev/null || true
  fi
  ln -snf "${OC_TMP}/cache" "${OC_ETC}/cache"

  # 可选：把 OpenClash 日志也引到 tmpfs（若你有固定日志路径）
  # 不同 OpenClash 版本日志路径不完全一致，这里只提供目录
  mkdir -p "${OC_ETC}/log" >/dev/null 2>&1 || true
}

start() {
  log "start"
  ensure_dirs

  if ! attach_custom_ubi; then
    log "ERROR: ubiattach mtd${CUSTOM_MTD_NUM} failed"
    return 1
  fi

  ensure_ubifs_volume || true

  if ! mount_custom; then
    log "ERROR: mount custom ubifs failed"
    return 1
  fi

  ensure_dirs
  link_openclash_paths

  log "OK: custom mounted at ${MNT}; openclash core->custom; geo/cache->tmpfs"
  return 0
}

stop() {
  log "stop"
  umount "${MNT}" >/dev/null 2>&1 || true
  ubidetach -p "${CUSTOM_MTD}" >/dev/null 2>&1 || true
}
